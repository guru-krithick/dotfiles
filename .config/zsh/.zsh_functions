# Python virtual environment auto-activation
_venv_auto_activate() {
  if [[ -z "$VIRTUAL_ENV" ]]; then
    for candidate in .venv venv .env; do
      if [[ -d "./$candidate" ]]; then
        source "./$candidate/bin/activate"
        break 
      fi
    done
  else
    parentdir="$(dirname "$VIRTUAL_ENV")"
    if [[ "$PWD"/ != "$parentdir"/* ]]; then
      deactivate
    fi
  fi
}

# Hook into cd command
function cd(){
  builtin cd "$@"
  _venv_auto_activate
}

# Hook into zoxide (z command)
if command -v zoxide >/dev/null 2>&1; then
  function z() {
    __zoxide_z "$@"
    _venv_auto_activate
  }
fi

# Also hook into chpwd for any directory changes
autoload -U add-zsh-hook
add-zsh-hook chpwd _venv_auto_activate

# HTTP Server Function
serve(){
  port=${1:-8000}
  python3 -m http.server "$port" && echo "HTTP server is running on http://localhost:$port" || {
    echo "Failed to start HTTP server on port $port"
    return 1
  }
}

vf() {
  local file
  file=$(
        git ls-files 2>/dev/null |
        fzf --preview 'bat --color=always --style=numbers {}' --preview-window=right:60%) &&
        nvim "$file"
}

gl() {
    git log --oneline --color=always |
    fzf --ansi --preview 'git show --color {1}' --preview-window=right:60%
}

extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2) tar xjf "$1" ;;
      *.tar.gz) tar xzf "$1" ;;
      *.bz2) bunzip2 "$1" ;;
      *.gz) gunzip "$1" ;;
      *.tar) tar xf "$1" ;;
      *.zip) unzip "$1" ;;
      *.Z) uncompress "$1" ;;
      *.7z) 7z x "$1" ;;
      *) echo "'$1' cannot be extracted" ;;
    esac
  fi
}

# Tmux Sessionizer (Ctrl+f to trigger)
bindkey -s '^f' '^u~/.config/zsh/scripts/tmux-sessionizer.sh\n'
